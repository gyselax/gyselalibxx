name: pages
on:
  push:
    branches: [ main ]
  pull_request:
jobs:
  docker-build:
    runs-on: ubuntu-latest
    steps:
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1
    - name: Set up Buildx
      uses: docker/setup-buildx-action@v1
    - name: Login to GHCR.io
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Cache pull
      run: docker pull ghcr.io/maison-de-la-simulation/ddc/doxygen:latest
    - name: Build
      uses: docker/build-push-action@v2
      with:
        context: "{{ defaultContext }}:docker/doxygen"
        pull: true
        load: true
        cache-from: type=registry,ref=ghcr.io/maison-de-la-simulation/ddc/doxygen:latest
        tags: ghcr.io/maison-de-la-simulation/ddc/doxygen:${{ github.sha }}
    - name: Tagged push
      uses: docker/build-push-action@v2
      with:
        context: "{{ defaultContext }}:docker/doxygen"
        push: true
        tags: ghcr.io/maison-de-la-simulation/ddc/doxygen:${{ github.sha }}
    - name: Publish
      if: ${{ github.event_name == 'push' && github.ref_name == 'main' }}
      uses: docker/build-push-action@v2
      with:
        context: "{{ defaultContext }}:docker/doxygen"
        cache-from: type=registry,ref=ghcr.io/maison-de-la-simulation/ddc/doxygen:${{ github.sha }}
        push: true
        tags: ghcr.io/maison-de-la-simulation/ddc/doxygen:latest
  pages:
    runs-on: ubuntu-latest
    needs: docker-build
    steps:
    - name: Checkout built branch
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
        submodules: true
    - name: Build site
      run: |
        cat<<-EOF > run.sh
          cmake -DBUILD_DOCUMENTATION=ON -DDDC_BUILD_PDI_WRAPPER=OFF /src
          if make doc 2>&1 | tee >(cat>&2) | grep ' warning: ' > /dev/null
          then
            make doc 2>&1 | grep ' warning: '
            exit 1
          fi
          mv docs/html /src/
        EOF
        docker run -v ${PWD}:/src:ro ghcr.io/maison-de-la-simulation/ddc/doxygen:${{ github.sha }} bash /src/run.sh
    - name: Publish site
      if: ${{ github.event_name == 'push' && github.ref_name == 'main' }}
      run: |
        git worktree add -B gh-pages public remotes/origin/gh-pages
        find public -mindepth 1 -maxdepth 1 '!' -name .git -exec rm -rf '{}' '+'
        mv html/* public/
        echo "ddc.mdls.fr" > public/CNAME
        git -C public config user.name "${GITHUB_ACTOR}"
        git -C public config user.email "${GITHUB_ACTOR}@noreply.example.com"
        git -C public add -A .
        git -C public commit -a -m "Update to match ${GITHUB_SHA} by ${GITHUB_EVENT_NAME} ${GITHUB_RUN_NUMBER}" || true
        git -C public push
