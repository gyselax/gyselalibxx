name: Acceptance tests

on:
  pull_request:
    branch: [ 'main' ]

jobs:
  cpu_tests:
    strategy:
      matrix:
        toolchain: [tests_toolchain.cmake, tests_release_toolchain.cmake, tests_release_omp_toolchain.cmake]
    name: CPU Test (${{ matrix.toolchain }})
    environment: manual_workflow
    uses: ./.github/workflows/cpu_tests.yml
    with:
      toolchain: ${{ matrix.toolchain }}
      merge_target: ${{ github.event.pull_request.base.ref }}

  gpu_tests:
    name: GPU Test (${{ matrix.toolchain }})
    if: github.event.pull_request.draft == false
    uses: ./.github/workflows/gpu_tests.yml
    with:
      toolchain: ./toolchains/v100.persee/toolchain.cmake
      merge_target: ${{ github.event.pull_request.base.ref }}

  resource_conservation:
    runs-on: ubuntu-latest
    needs: [cpu_tests, gpu_tests]
    if: failure()
    steps:
    - name: Resource conservation
      run:
        gh pr ready ${{ github.event.pull_request.number }} --undo
