name: Functionality tests

on:
  workflow_call:
    inputs:
      additional_cmake_commands:
        description: 'Any additional commands/flags which should be passed to cmake'
        default: ''
        required: false
        type: string
      ctest_commands:
        description: 'Any additional commands/flags which should be passed to ctest'
        default: ''
        required: false
        type: string
      filter_tests:
        description: 'Indicates whether tests should be filtered to reduce the quantity'
        required: true
        type: bool

jobs:
    tests:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/gyselax/gyselalibxx_env
      options: --user root
    steps:
      - name: Checkout gyselalibxx
        uses: actions/checkout@v3
        with:
          submodules: true
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            sll:
              - 'vendor/sll/**'
            poisson_2d:
              - 'src/geometryRTheta/poisson/**'
      - uses: .github/actions/functionality_tests
        with:
          additional_cmake_commands: ${{ inputs.additional_cmake_commands }}
          ctest_commands: ${{ inputs.ctest_commands }}
          SLL_BUILD_TESTING: ${{ inputs.filter_tests && steps.changes.outputs.sll || 'ON' }}
          POISSON_2D_TESTING: ${{ inputs.filter_tests && steps.changes.outputs.poisson_2d || 'ON' }}
      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always() # always run even if the previous step fails
        with:
          report_paths: 'build/tests.xml'
