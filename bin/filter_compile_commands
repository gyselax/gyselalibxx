#!/usr/bin/env python3
import argparse
import json
from pathlib import Path

GYSELALIB_ROOT = Path(__file__).parent.parent

if __name__ == '__main__':
    parser = argparse.ArgumentParser("Filter compile commands to only look at relevenat folders.")
    parser.add_argument('build_dir', metavar='BUILD_DIR', help='The build directory containing the compile commands.',
                        type=Path)
    parser.add_argument('folders', metavar='FOLDERS', help='The folders in which the code you would like to test is found.',
                        nargs='+')
    parser.add_argument('--exclude', metavar='FOLDERS', help='The folders to be excluded from tests.',
                        nargs='*', default=())
    args = parser.parse_args()

    with open(args.build_dir / 'compile_commands.json', encoding='utf-8') as f:
        config = json.load(f)

    relevant_folders = [Path(r).absolute() for r in args.folders]
    exclude_folders = [Path(r).absolute() for r in args.exclude]

    relevant_configs = [c for c in config if any(r in Path(c['file']).parents for r in relevant_folders) and not any(r in Path(c['file']).parents for r in exclude_folders)]

    #for c in relevant_configs:
    #    c['command'] = ' '.join(s for s in c['command'].split() if not (s.startswith('-I') and '/vendor/' in s))

    with open(args.build_dir / 'relevant_compile_commands.json', 'w', encoding='utf-8') as f:
        config = json.dump(relevant_configs, f, indent=2)
