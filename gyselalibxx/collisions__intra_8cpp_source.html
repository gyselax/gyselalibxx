<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>File collisions_intra.cpp - GyselalibX</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "File collisions_intra.cpp";
        var mkdocs_page_input_path = "gyselalibxx/collisions__intra_8cpp_source.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> GyselalibX
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">General</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >First Steps</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../docs/first_steps/getting_started.html">Getting Started</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Installation</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../docs/first_steps/install.html">Gyselalib++ Installation</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../toolchains/index.html">Pre-made build settings</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../docs/first_steps/DDC_in_gyselalibxx.html">DDC in Gyselalib++</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Standards</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../docs/standards/CODING_STANDARD.html">Coding Standard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../docs/standards/mathematical_and_physical_conventions.html">Math & Physics</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Gyselalib++</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Source</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../src/index.html">Gyselalib++ contents</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >advection</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/advection/index.html">Advection methods</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >collisions</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/collisions/index.html">Collisions</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >data_types</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/data_types/index.html">Data Storage Types</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >geometryRTheta</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/geometryRTheta/index.html">Geometry (r, theta)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >advection</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryRTheta/advection/index.html">Advection operator</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >advection_field</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryRTheta/advection_field/index.html">Advection Field finder</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >geometry</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryRTheta/geometry/index.html">Geometry RTheta</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >initialisation</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryRTheta/initialisation/index.html">Initialisation</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >poisson</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryRTheta/poisson/index.html">Polar Poisson solver</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >time_solver</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryRTheta/time_solver/index.html">Predictor-corrector methods</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >geometryVparMu</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/geometryVparMu/index.html">Geometry (vpar, mu)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >collisions</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryVparMu/collisions/index.html">CollisionConfiguration</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >geometry</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryVparMu/geometry/index.html">GeometryVparMu</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >initialisation</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryVparMu/initialisation/index.html">Initialisation methods</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >geometryXVx</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/geometryXVx/index.html">Geometry (x, v_x)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >boltzmann</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXVx/boltzmann/index.html">Boltzmann solver</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >geometry</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXVx/geometry/index.html">Geometry X-Vx</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >initialisation</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXVx/initialisation/index.html">Initialisation methods</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >poisson</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXVx/poisson/index.html">Quasi-Neutrality Solver</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >rhs</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXVx/rhs/index.html">RHS</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >time_integration</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXVx/time_integration/index.html">Time integration</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >utils</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXVx/utils/index.html">Utils</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >geometryXY</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/geometryXY/index.html">Geometry (x, y)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >geometry</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXY/geometry/index.html">Geometry XY</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >initialisation</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXY/initialisation/index.html">Initialisation on (x,y) geometry</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >time_integration</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXY/time_integration/index.html">Predictor-corrector methods</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >geometryXYVxVy</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/geometryXYVxVy/index.html">Geometry (x, y, v_x, v_y)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >geometry</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXYVxVy/geometry/index.html">Geometry X Y-Vx Vy</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >initialisation</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXYVxVy/initialisation/index.html">Initialisation methods</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >poisson</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXYVxVy/poisson/index.html">Quasi-Neutrality Solver</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >time_integration</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXYVxVy/time_integration/index.html">Time integration</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >vlasov</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/geometryXYVxVy/vlasov/index.html">Vlasov solver</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >interpolation</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/interpolation/index.html">Interpolation Methods</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >polar_splines</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/interpolation/polar_splines/index.html">Polar Splines</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >io</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/io/index.html">Functions used for input and output</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >mapping</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/mapping/index.html">Mappings</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >math_tools</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/math_tools/index.html">Utility Functions</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >matrix_tools</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/matrix_tools/index.html">Matrix tools</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >mpi_parallelisation</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/mpi_parallelisation/index.html">Parallelisation</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >multipatch</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/multipatch/index.html">Multipatch</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >connectivity</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/multipatch/connectivity/index.html">Multipatch connectivity</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >data_types</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/multipatch/data_types/index.html">Data Types for Multipatch Geometry</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >spline</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/multipatch/spline/index.html">Spline on multipatch geometry</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >utils</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../src/multipatch/utils/index.html">Multipatch utilitary functions</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >pde_solvers</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/pde_solvers/index.html">PDE Solvers</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >quadrature</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/quadrature/index.html">Quadrature Methods</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >speciesinfo</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/speciesinfo/index.html">SpeciesInfo (x, v_x)</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >timestepper</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/timestepper/index.html">Time Stepping Methods</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >utils</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../src/utils/index.html">Utility Functions</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Simulations</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../simulations/index.html">Gyselalib++ simulations</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >geometryRTheta</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../simulations/geometryRTheta/index.html">Simulations in (r, theta) geometry</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >diocotron</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../simulations/geometryRTheta/diocotron/index.html">Diocotron instability</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >vortex_merger</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../simulations/geometryRTheta/vortex_merger/index.html">Vortex merger</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >geometryXVx</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../simulations/geometryXVx/index.html">Simulations in (x, vx) geometry</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >geometryXY</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../simulations/geometryXY/index.html">Simulations in (x, y) geometry</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >guiding_centre</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../simulations/geometryXY/guiding_centre/index.html">Guiding centre (X,Y) simulation</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Tests</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../tests/index.html">Gyselalib++ tests</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >advection</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../tests/advection/index.html">Tests on the templated advection operators</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >geometryRTheta</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../tests/geometryRTheta/index.html">Tests : Geometry (r, theta)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >advection_rtheta</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../tests/geometryRTheta/advection_rtheta/index.html">Tests on the 2D polar advection operator</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >polar_poisson</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../tests/geometryRTheta/polar_poisson/index.html">Tests on the 2D polar poisson solver</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >spline_interpolator_rtheta</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../tests/geometryRTheta/spline_interpolator_rtheta/index.html">Tests on spline interpolator in polar coordinates</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >multipatch</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../tests/multipatch/index.html">Multipatch geometry tests</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >geometries</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../tests/multipatch/geometries/index.html">Multipatch geometries</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../docs/development/Adding_docs.html">Adding Docs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../docs/development/Using_git.html">Using Git</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../docs/development/developer_FAQ.html">Developer FAQ</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Troubleshooting</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../docs/troubleshooting/Common_compilation_problems.html">Compilation Issues</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Gyselalib++</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >Classes</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="annotated.html">Class List</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="classes.html">Class Index</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="hierarchy.html">Class Hierarchy</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Namespaces</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="namespaces.html">Namespace List</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="namespace_members.html">Namespace Members</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="namespace_member_functions.html">Namespace Member Functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="namespace_member_variables.html">Namespace Member Variables</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="namespace_member_typedefs.html">Namespace Member Typedefs</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="namespace_member_enums.html">Namespace Member Enumerations</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="functions.html">Functions</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="variables.html">Variables</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="macros.html">Macros</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="files.html">Files</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">GyselalibX</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">File collisions_intra.cpp</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/gyselax/gyselalibxx/edit/master/docs/gyselalibxx/collisions__intra_8cpp_source.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div><h1 id="file-collisions_intracpp">File collisions_intra.cpp</h1>
<p><a href="files.html"><strong>File List</strong></a> <strong>&gt;</strong> <a href="dir_e51b496b46dd687775e46e0826614574.html"><strong>geometryXVx</strong></a> <strong>&gt;</strong> <a href="dir_53474cb30a3389ee74cb3186cae99ac0.html"><strong>rhs</strong></a> <strong>&gt;</strong> <a href="collisions__intra_8cpp.html"><strong>collisions_intra.cpp</strong></a></p>
<p><a href="collisions__intra_8cpp.html">Go to the documentation of this file</a></p>
<pre><code class="language-C++">#include &lt;iomanip&gt;

#include &lt;ddc/ddc.hpp&gt;
#include &lt;ddc/pdi.hpp&gt;

#include "collisions_intra.hpp"
#include "collisions_utils.hpp"
#include "fluid_moments.hpp"
#include "matrix_batch_tridiag.hpp"

template &lt;class TargetDim&gt;
KOKKOS_FUNCTION Idx&lt;TargetDim&gt; CollisionsIntra::to_index(Idx&lt;GridVx&gt; const&amp; index)
{
    static_assert(
            std::is_same_v&lt;TargetDim, GhostedVx&gt; || std::is_same_v&lt;TargetDim, GhostedVxStaggered&gt;);
    if constexpr (std::is_same_v&lt;TargetDim, GhostedVx&gt;) {
        return Idx&lt;GhostedVx&gt;(index.uid() + 1);
    } else {
        return Idx&lt;GhostedVxStaggered&gt;(index.uid() + 1);
    }
}

// The "Spoof" variables will be identical to the non-spoof versions. They are simply used
// to prevent the compiler from trying to compile code for the non-uniform case when splines
// are uniform.
template &lt;class GridVxSpoof, class GhostedVxSpoof, class GhostedVxStaggeredSpoof&gt;
std::enable_if_t&lt;!ddc::is_uniform_point_sampling_v&lt;GridVxSpoof&gt;&gt; CollisionsIntra::
        build_ghosted_staggered_vx_point_sampling(IdxRange&lt;GridVxSpoof&gt; const&amp; idx_range)
{
    static_assert(
            std::is_same_v&lt;GridVxSpoof, GridVx&gt;,
            "The function is only designed to work with the GridVx dimension");
    static_assert(std::is_same_v&lt;GhostedVxSpoof, GhostedVx&gt;);
    static_assert(std::is_same_v&lt;GhostedVxStaggeredSpoof, GhostedVxStaggered&gt;);

    CoordVx const v0 = ddc::coordinate(idx_range.front());
    CoordVx const v1 = ddc::coordinate(idx_range.front() + 1);
    CoordVx const vN = ddc::coordinate(idx_range.back());
    CoordVx const vNm1 = ddc::coordinate(idx_range.back() - 1);
    int const ncells(idx_range.size() - 1);

    // ghosted points
    int const npoints(ncells + 3);
    std::vector&lt;CoordVx&gt; breaks(npoints);
    breaks[0] = v0 - (v1 - v0);
    breaks[npoints - 1] = vN + (vN - vNm1);
    ddc::for_each(idx_range, [&amp;](IdxVx const iv) {
        breaks[to_index&lt;GhostedVx&gt;(iv).uid()] = ddc::coordinate(iv);
    });
    ddc::init_discrete_space&lt;GhostedVxSpoof&gt;(breaks);

    // ghosted staggered points
    int const npoints_stag(ncells + 2);
    std::vector&lt;CoordVx&gt; breaks_stag(npoints_stag);
    breaks_stag[0] = v0 - (v1 - v0) / 2.;
    breaks_stag[npoints_stag - 1] = vN + (vN - vNm1) / 2.;
    IdxRangeVx const gridv_less(idx_range.remove_last(IdxStepVx(1)));
    ddc::for_each(gridv_less, [&amp;](IdxVx const iv) {
        breaks_stag[iv.uid() + 1] = CoordVx((ddc::coordinate(iv) + ddc::coordinate(iv + 1)) / 2.);
    });
    ddc::init_discrete_space&lt;GhostedVxStaggeredSpoof&gt;(breaks_stag);
}

// The "Spoof" variables will be identical to the non-spoof versions. They are simply used
// to prevent the compiler from trying to compile code for the uniform case when splines
// are non-uniform.
template &lt;class GridVxSpoof, class GhostedVxSpoof, class GhostedVxStaggeredSpoof&gt;
std::enable_if_t&lt;ddc::is_uniform_point_sampling_v&lt;GridVxSpoof&gt;&gt; CollisionsIntra::
        build_ghosted_staggered_vx_point_sampling(IdxRange&lt;GridVxSpoof&gt; const&amp; idx_range)
{
    static_assert(
            std::is_same_v&lt;GridVxSpoof, GridVx&gt;,
            "The function is only designed to work with the GridVx dimension");
    static_assert(std::is_same_v&lt;GhostedVxSpoof, GhostedVx&gt;);
    static_assert(std::is_same_v&lt;GhostedVxStaggeredSpoof, GhostedVxStaggered&gt;);

    CoordVx const v0 = ddc::coordinate(idx_range.front());
    CoordVx const vN = ddc::coordinate(idx_range.back());
    int const ncells(idx_range.size() - 1);
    double const step(ddc::step&lt;GridVxSpoof&gt;());

    // ghosted points
    ddc::init_discrete_space&lt;GhostedVx&gt;(
            GhostedVxSpoof::init(v0 - step, vN + step, IdxStep&lt;GhostedVx&gt;(ncells + 3)));

    // ghosted staggered points
    ddc::init_discrete_space&lt;GhostedVxStaggered&gt;(
            GhostedVxStaggeredSpoof::
                    init(v0 - step / 2, vN + step / 2, IdxStep&lt;GhostedVxStaggered&gt;(ncells + 2)));
}

CollisionsIntra::CollisionsIntra(IdxRangeSpXVx const&amp; mesh, double nustar0)
    : m_nustar0(nustar0)
    , m_fthresh(1.e-30)
    , m_nustar_profile_alloc(ddc::select&lt;Species, GridX&gt;(mesh))
    , m_gridvx_ghosted(Idx&lt;GhostedVx&gt;(0), IdxStep&lt;GhostedVx&gt;(ddc::select&lt;GridVx&gt;(mesh).size() + 2))
    , m_gridvx_ghosted_staggered(
              Idx&lt;GhostedVxStaggered&gt;(0),
              IdxStep&lt;GhostedVxStaggered&gt;(ddc::select&lt;GridVx&gt;(mesh).size() + 1))
    , m_mesh_ghosted(ddc::select&lt;Species&gt;(mesh), ddc::select&lt;GridX&gt;(mesh), m_gridvx_ghosted)
    , m_mesh_ghosted_staggered(
              ddc::select&lt;Species&gt;(mesh),
              ddc::select&lt;GridX&gt;(mesh),
              m_gridvx_ghosted_staggered)

{
    // validity checks
    if (ddc::select&lt;Species&gt;(mesh).size() != 2) {
        throw std::runtime_error("Intra species collisions requires two kinetic species.");
    }
    if (m_nustar0 == 0.) {
        throw std::invalid_argument("Collision operator should not be used with nustar0=0.");
    }

    build_ghosted_staggered_vx_point_sampling(ddc::select&lt;GridVx&gt;(mesh));

    m_nustar_profile = get_field(m_nustar_profile_alloc);
    compute_nustar_profile(m_nustar_profile, m_nustar0);
    ddc::expose_to_pdi("collintra_nustar0", m_nustar0);
}

IdxRange&lt;CollisionsIntra::GhostedVx&gt; const&amp; CollisionsIntra::get_gridvx_ghosted() const
{
    return m_gridvx_ghosted;
}

IdxRange&lt;CollisionsIntra::GhostedVxStaggered&gt; const&amp; CollisionsIntra::get_gridvx_ghosted_staggered()
        const
{
    return m_gridvx_ghosted_staggered;
}

IdxRange&lt;Species, GridX, CollisionsIntra::GhostedVx&gt; const&amp; CollisionsIntra::get_mesh_ghosted()
        const
{
    return m_mesh_ghosted;
}

void CollisionsIntra::compute_matrix_coeff(
        DFieldSpXVx AA,
        DFieldSpXVx BB,
        DFieldSpXVx CC,
        DField&lt;IdxRangeSpXVx_ghosted&gt; Dcoll,
        DField&lt;IdxRangeSpXVx_ghosted_staggered&gt; Dcoll_staggered,
        DField&lt;IdxRangeSpXVx_ghosted&gt; Nucoll,
        double deltat) const
{
    ddc::parallel_for_each(
            Kokkos::DefaultExecutionSpace(),
            get_idx_range(AA),
            KOKKOS_LAMBDA(IdxSpXVx const ispxvx) {
                IdxSp const isp = ddc::select&lt;Species&gt;(ispxvx);
                IdxX const ix = ddc::select&lt;GridX&gt;(ispxvx);
                IdxVx const ivx = ddc::select&lt;GridVx&gt;(ispxvx);

                IdxVx_ghosted ivx_ghosted(to_index&lt;GhostedVx&gt;(ivx));
                IdxVx_ghosted_staggered ivx_ghosted_staggered(to_index&lt;GhostedVxStaggered&gt;(ivx));
                IdxVx_ghosted ivx_next_ghosted(ivx_ghosted + 1);
                IdxVx_ghosted ivx_prev_ghosted(ivx_ghosted - 1);
                IdxVx_ghosted_staggered ivx_prev_ghosted_staggered(ivx_ghosted_staggered - 1);

                double const dv_i
                        = ddc::coordinate(ivx_next_ghosted) - ddc::coordinate(ivx_ghosted);
                double const delta_i
                        = dv_i / (ddc::coordinate(ivx_ghosted) - ddc::coordinate(ivx_prev_ghosted));

                double const alpha_i = deltat / (dv_i * dv_i * (1. + delta_i));
                double const beta_i = deltat / (2. * dv_i * (1. + delta_i));

                double const coeffa
                        = alpha_i
                                  * (Dcoll_staggered(isp, ix, ivx_prev_ghosted_staggered) * delta_i
                                             * delta_i * delta_i
                                     - Dcoll(isp, ix, ivx_ghosted) * delta_i * delta_i
                                               * (delta_i - 1.))
                          + beta_i * Nucoll(isp, ix, ivx_prev_ghosted) * delta_i * delta_i;

                double const coeffb
                        = -alpha_i
                                  * (-Dcoll_staggered(isp, ix, ivx_ghosted_staggered)
                                     - Dcoll_staggered(isp, ix, ivx_prev_ghosted_staggered)
                                               * delta_i * delta_i * delta_i
                                     + Dcoll(isp, ix, ivx_ghosted) * (delta_i - 1.)
                                               * (delta_i * delta_i - 1.))
                          + beta_i * Nucoll(isp, ix, ivx_ghosted) * (delta_i * delta_i - 1.);

                double const coeffc = alpha_i
                                              * (Dcoll_staggered(isp, ix, ivx_ghosted_staggered)
                                                 + Dcoll(isp, ix, ivx_ghosted) * (delta_i - 1.))
                                      - beta_i * Nucoll(isp, ix, ivx_next_ghosted);

                AA(ispxvx) = -coeffa;
                BB(ispxvx) = 1. + coeffb;
                CC(ispxvx) = -coeffc;
            });
}

void CollisionsIntra::fill_matrix_with_coeff(
        Matrix_Banded&amp; matrix,
        host_t&lt;DConstFieldVx&gt; AA,
        host_t&lt;DConstFieldVx&gt; BB,
        host_t&lt;DConstFieldVx&gt; CC) const
{
    matrix.set_element(0, 0, BB(IdxVx(0)));
    matrix.set_element(0, 1, CC(IdxVx(0)));

    int const npoints(get_idx_range&lt;GridVx&gt;(AA).size());
    matrix.set_element(npoints - 1, npoints - 1, BB(IdxVx(npoints - 1)));
    matrix.set_element(npoints - 1, npoints - 2, AA(IdxVx(npoints - 1)));

    IdxRangeVx const gridvx_inner(
            get_idx_range&lt;GridVx&gt;(AA).remove_first(IdxStepVx(1)).remove_last(IdxStepVx(1)));
    ddc::for_each(gridvx_inner, [&amp;](IdxVx const ivx) {
        matrix.set_element(ivx.uid(), ivx.uid() - 1, AA(ivx));
        matrix.set_element(ivx.uid(), ivx.uid(), BB(ivx));
        matrix.set_element(ivx.uid(), ivx.uid() + 1, CC(ivx));
    });
}

void CollisionsIntra::compute_rhs_vector(
        DFieldSpXVx RR,
        DConstFieldSpXVx AA,
        DConstFieldSpXVx BB,
        DConstFieldSpXVx CC,
        DConstFieldSpXVx allfdistribu,
        double fthresh) const
{
    IdxRangeVx const idx_range_vx(get_idx_range&lt;GridVx&gt;(AA));

    ddc::parallel_for_each(
            Kokkos::DefaultExecutionSpace(),
            get_idx_range(RR),
            KOKKOS_LAMBDA(IdxSpXVx const ispxvx) {
                IdxSp const isp = ddc::select&lt;Species&gt;(ispxvx);
                IdxX const ix = ddc::select&lt;GridX&gt;(ispxvx);
                IdxVx const ivx = ddc::select&lt;GridVx&gt;(ispxvx);

                IdxVx const ivx_next = ivx + 1;
                IdxVx const ivx_prev = ivx - 1;

                if (ivx == idx_range_vx.front()) {
                    RR(isp, ix, ivx) = (2. - BB(isp, ix, ivx)) * allfdistribu(isp, ix, ivx)
                                       + (-CC(isp, ix, ivx)) * allfdistribu(isp, ix, ivx_next)
                                       - 2. * AA(isp, ix, ivx) * fthresh;

                } else if (ivx == idx_range_vx.back()) {
                    RR(isp, ix, ivx) = (2. - BB(isp, ix, ivx)) * allfdistribu(isp, ix, ivx)
                                       + (-AA(isp, ix, ivx)) * allfdistribu(isp, ix, ivx_prev)
                                       - 2. * CC(isp, ix, ivx) * fthresh;

                } else {
                    RR(isp, ix, ivx) = -AA(isp, ix, ivx) * allfdistribu(isp, ix, ivx_prev)
                                       + (2. - BB(isp, ix, ivx)) * allfdistribu(isp, ix, ivx)
                                       - CC(isp, ix, ivx) * allfdistribu(isp, ix, ivx_next);
                }
            });
}



DFieldSpXVx CollisionsIntra::operator()(DFieldSpXVx allfdistribu, double dt) const
{
    Kokkos::Profiling::pushRegion("CollisionsIntra");

    IdxRangeSpX grid_sp_x(get_idx_range&lt;Species, GridX&gt;(allfdistribu));
    // density and temperature
    DFieldMemSpX density_alloc(grid_sp_x);
    DFieldMemSpX fluid_velocity_alloc(grid_sp_x);
    DFieldMemSpX temperature_alloc(grid_sp_x);
    DFieldSpX density = get_field(density_alloc);
    DFieldSpX fluid_velocity = get_field(fluid_velocity_alloc);
    DFieldSpX temperature = get_field(temperature_alloc);

    DFieldMemVx const quadrature_coeffs_alloc(
            trapezoid_quadrature_coefficients&lt;Kokkos::DefaultExecutionSpace&gt;(
                    get_idx_range&lt;GridVx&gt;(allfdistribu)));
    DConstFieldVx quadrature_coeffs = get_const_field(quadrature_coeffs_alloc);

    IdxRangeVx const idx_range_vx(get_idx_range&lt;GridVx&gt;(allfdistribu));

    //Moments computation
    ddc::parallel_fill(density, 0.);
    ddc::parallel_for_each(
            Kokkos::DefaultExecutionSpace(),
            grid_sp_x,
            KOKKOS_LAMBDA(IdxSpX const ispx) {
                double particle_flux(0);
                double momentum_flux(0);
                for (IdxVx const ivx : idx_range_vx) {
                    CoordVx const coordv = ddc::coordinate(ivx);
                    double const val(quadrature_coeffs(ivx) * allfdistribu(ispx, ivx));
                    density(ispx) += val;
                    particle_flux += val * coordv;
                    momentum_flux += val * coordv * coordv;
                }
                fluid_velocity(ispx) = particle_flux / density(ispx);
                temperature(ispx)
                        = (momentum_flux - particle_flux * fluid_velocity(ispx)) / density(ispx);
            });

    // collision frequency
    DFieldMemSpX collfreq_alloc(grid_sp_x);
    DFieldSpX collfreq = get_field(collfreq_alloc);
    compute_collfreq(
            collfreq,
            get_const_field(m_nustar_profile),
            get_const_field(density),
            get_const_field(temperature));

    // diffusion coefficient
    DFieldMem&lt;IdxRangeSpXVx_ghosted&gt; Dcoll_alloc(m_mesh_ghosted);
    DField&lt;IdxRangeSpXVx_ghosted&gt; Dcoll = get_field(Dcoll_alloc);
    compute_Dcoll&lt;GhostedVx&gt;(
            Dcoll,
            get_const_field(collfreq),
            get_const_field(density),
            get_const_field(temperature));

    DFieldMem&lt;IdxRangeSpXVx_ghosted&gt; dvDcoll_alloc(m_mesh_ghosted);
    DField&lt;IdxRangeSpXVx_ghosted&gt; dvDcoll = get_field(dvDcoll_alloc);
    compute_dvDcoll&lt;GhostedVx&gt;(
            dvDcoll,
            get_const_field(collfreq),
            get_const_field(density),
            get_const_field(temperature));

    DFieldMem&lt;IdxRangeSpXVx_ghosted_staggered&gt; Dcoll_staggered_alloc(m_mesh_ghosted_staggered);
    DField&lt;IdxRangeSpXVx_ghosted_staggered&gt; Dcoll_staggered = get_field(Dcoll_staggered_alloc);
    compute_Dcoll&lt;GhostedVxStaggered&gt;(
            Dcoll_staggered,
            get_const_field(collfreq),
            get_const_field(density),
            get_const_field(temperature));

    // kernel maxwellian fluid moments
    DFieldMemSpX Vcoll_alloc(grid_sp_x);
    DFieldMemSpX Tcoll_alloc(grid_sp_x);
    DFieldSpX Vcoll = get_field(Vcoll_alloc);
    DFieldSpX Tcoll = get_field(Tcoll_alloc);
    compute_Vcoll_Tcoll&lt;GhostedVx&gt;(Vcoll, Tcoll, get_const_field(allfdistribu), Dcoll, dvDcoll);

    // convection coefficient Nucoll
    DFieldMem&lt;IdxRangeSpXVx_ghosted&gt; Nucoll_alloc(m_mesh_ghosted);
    DField&lt;IdxRangeSpXVx_ghosted&gt; Nucoll = get_field(Nucoll_alloc);
    compute_Nucoll&lt;GhostedVx&gt;(Nucoll, Dcoll, get_const_field(Vcoll), get_const_field(Tcoll));

    // matrix coefficients
    DFieldMemSpXVx AA_alloc(get_idx_range(allfdistribu));
    DFieldMemSpXVx BB_alloc(get_idx_range(allfdistribu));
    DFieldMemSpXVx CC_alloc(get_idx_range(allfdistribu));
    DFieldSpXVx AA = get_field(AA_alloc);
    DFieldSpXVx BB = get_field(BB_alloc);
    DFieldSpXVx CC = get_field(CC_alloc);
    compute_matrix_coeff(AA, BB, CC, Dcoll, Dcoll_staggered, Nucoll, dt);


    // rhs vector coefficient
    DFieldMemSpXVx RR_alloc(get_idx_range(allfdistribu));
    DFieldSpXVx RR = get_field(RR_alloc);
    compute_rhs_vector(
            RR,
            get_const_field(AA),
            get_const_field(BB),
            get_const_field(CC),
            get_const_field(allfdistribu),
            m_fthresh);

    int const batch_size = get_idx_range&lt;Species, GridX&gt;(allfdistribu).size();
    int const mat_size = get_idx_range&lt;GridVx&gt;(allfdistribu).size();
    /* Here we do not use allocation_kokkos_view() ddc function since we change the shape 
       from (Sp,X,Vx)--&gt;(batch_dim,Vx)*/
    Kokkos::View&lt;double**, Kokkos::LayoutRight, Kokkos::DefaultExecutionSpace&gt;
            AA_view(AA.data_handle(), batch_size, mat_size);
    Kokkos::View&lt;double**, Kokkos::LayoutRight, Kokkos::DefaultExecutionSpace&gt;
            BB_view(BB.data_handle(), batch_size, mat_size);
    Kokkos::View&lt;double**, Kokkos::LayoutRight, Kokkos::DefaultExecutionSpace&gt;
            CC_view(CC.data_handle(), batch_size, mat_size);
    Kokkos::View&lt;double**, Kokkos::LayoutRight, Kokkos::DefaultExecutionSpace&gt;
            RR_view(RR.data_handle(), batch_size, mat_size);


    MatrixBatchTridiag&lt;Kokkos::DefaultExecutionSpace&gt;
            matrix(batch_size, mat_size, AA_view, BB_view, CC_view);
    matrix.setup_solver();
    matrix.solve(RR_view);

    ddc::parallel_deepcopy(allfdistribu, RR);
    Kokkos::Profiling::popRegion();
    return allfdistribu;
}
</code></pre></div>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/gyselax/gyselalibxx/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../docs/jscript/mathjax.js"></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
