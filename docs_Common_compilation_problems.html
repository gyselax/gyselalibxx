<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gyselalib++: Common compilation problems</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Gyselalib++
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('docs_Common_compilation_problems.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Common compilation problems </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="KOKKOS-LAMBDA"></a></p>
<h1><a class="anchor" id="docs_Common_compilation_problems__The_closure_type_for_a_lambda_cannot_be_used_in_the_template_argument_type_of_a____global____function"></a>
The closure type for a lambda cannot be used in the template argument type of a '__global__' function</h1>
<p>When using <code>ddc::parallel_for_each</code> or <code>ddc::parallel_transform_reduce</code> the last argument passed to the functions is usually a lambda function. The usual syntax for lambda functions is: </p><div class="fragment"><div class="line">[capture_expression](ArgTypes arguments) { code; }</div>
</div><!-- fragment --><p> When compiling for GPU this syntax must be modified slightly.</p>
<p>The only valid capture expression is capture by copy (i.e. everything used in the code which is defined elsewhere is passed by copy). This is so that objects (especially scalars) can be copied to the device when they are needed. A capture by reference would lead to the code trying to use objects on the GPU which are only accessible from the CPU.</p>
<h3><a class="anchor" id="autotoc_md12"></a>
Error Message</h3>
<p>When this rule is not followed you will see the following error message: </p><div class="fragment"><div class="line">${GYSELALIBXX_HOME}/vendor/kokkos/core/src/Cuda/Kokkos_Cuda_KernelLaunch.hpp(345): error: The closure type for a lambda (&quot;lambda [](ArgTypes)-&gt;void&quot;, defined at &lt;PATH_TO_FILE&gt;:&lt;LINE_NUMBER&gt;) cannot be used in the template argument type of a __global__ function template instantiation, unless the lambda is defined within a __device__ or __global__ function, or the flag &#39;-extended-lambda&#39; is specified and the lambda is an extended lambda (a __device__ or __host__ __device__ lambda defined within a __host__ or __host__ __device__ function)</div>
</div><!-- fragment --><h1><a class="anchor" id="docs_Common_compilation_problems__Implicit_capture_of__this__in_extended_lambda_expression"></a>
Implicit capture of 'this' in extended lambda expression</h1>
<p>Lambdas capture variables from their environment in order to use them in the expressions that are executed in the lambda function. They can capture local variables directly (by copy or reference), however in order to capture class variables the entire class must be captured. As captures for GPU require copies (see <a href="#KOKKOS-LAMBDA">above</a>) such a copy could be extremely costly. It is therefore advised to avoid class capture.</p>
<p>Luckily it is simple to avoid the class being captured. It is sufficient to define local copies or accessors (i.e. <code>ddc::ChunkSpan</code>) to the variables that will be used in the function.</p>
<p>E.g. for the following code: </p><div class="fragment"><div class="line"><span class="keywordtype">double</span> my_function()<span class="keyword"> const </span></div>
<div class="line"><span class="keyword"></span>{   </div>
<div class="line">    <span class="keywordflow">return</span> ddc::parallel_transform_reduce(</div>
<div class="line">            Kokkos::DefaultExecutionSpace(),</div>
<div class="line">            m_class_field_x.domain(),</div>
<div class="line">            KOKKOS_LAMBDA(IdxX ix) { <span class="keywordflow">return</span> m_class_field_x(ix); });</div>
<div class="line">}</div>
</div><!-- fragment --><p> where <code>m_class_field_x</code> is a class member function the code should be: </p><div class="fragment"><div class="line"><span class="keywordtype">double</span> my_function()<span class="keyword"> const </span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    DSpanX class_field_x_proxy = m_class_field_x.span_view();   </div>
<div class="line">    <span class="keywordflow">return</span> ddc::parallel_transform_reduce(</div>
<div class="line">            Kokkos::DefaultExecutionSpace(),</div>
<div class="line">            class_field_x_proxy.domain(),</div>
<div class="line">            KOKKOS_LAMBDA(IdxX ix) { <span class="keywordflow">return</span> class_field_x_proxy(ix); });</div>
<div class="line">}</div>
</div><!-- fragment --><p>Unfortunately the error message is only a warning so if this is missed the code will still compile but the results may be wrong.</p>
<h3><a class="anchor" id="autotoc_md13"></a>
Error Message</h3>
<p>When this rule is not followed you will see the following error message: </p><div class="fragment"><div class="line">&lt;PATH_TO_FILE&gt;(&lt;LINE_NUMBER&gt;): warning #20178-D: Implicit capture of &#39;this&#39; in extended lambda expression</div>
</div><!-- fragment --><h1><a class="anchor" id="docs_Common_compilation_problems__Accessing_allocated_data"></a>
Accessing allocated data</h1>
<p>DDC provides 3 types of objects for storing/accessing array data:</p><ul>
<li><code>ddc::Chunk</code></li>
<li><code>ddc::ChunkSpan</code></li>
<li><code>ddc::ChunkView</code></li>
</ul>
<p>Whenever a new <code>ddc::Chunk</code> is created, memory is allocated. This includes when a <code>ddc::Chunk</code> is copied. In order to avoid accidental memory allocation the copy operator of <code>ddc::Chunk</code> is therefore deleted.</p>
<p>This is a little awkward as it means that a <code>ddc::Chunk</code> then cannot be used as a function argument or used inside a GPU function (as captures for GPU require copies, see <a href="#KOKKOS-LAMBDA">above</a>). In order to get round this restriction the <code>ddc::ChunkSpan</code> type must be used. This type provides all the functionalities to access the data that is stored in a <code>ddc::Chunk</code> but creating/copying this object never allocates memory so there is no risk of accidental memory allocation. A <code>ddc::ChunkView</code> is almost identical to a <code>ddc::ChunkSpan</code> but the data it refers to cannot be modified.</p>
<p>In practice this means that while <code>ddc::Chunk</code> is used to initialise the memory, only <code>ddc::ChunkSpan</code> or <code>ddc::ChunkView</code> should be used to interact with the memory.</p>
<h3><a class="anchor" id="autotoc_md14"></a>
Error Message</h3>
<p>When this rule is not followed you may see a large number of errors. The following is a selection of the error messages that you may see:</p>
<p>The first error to appear is not very explicit. It simply indicates that the lvalue (the value on the left hand side of the assignment) has an unknown type. As a result the compiler does not know how to assing a value to it: </p><div class="fragment"><div class="line">&lt;PATH_TO_FILE&gt;(&lt;LINE_NUMBER&gt;): error: expression must be a modifiable lvalue</div>
</div><!-- fragment --><p>The next error highlights the problem. It says that a <code>ddc::Chunk</code> cannot be copied using a constructor. This is because such an operation would allocate memory and this is not what is wanted. </p><div class="fragment"><div class="line">&lt;PATH_TO_FILE&gt;(&lt;LINE_NUMBER&gt;): error: function &quot;ddc::Chunk&lt;ElementType, ddc::DiscreteDomain&lt;DDims...&gt;, Allocator&gt;::Chunk(const ddc::Chunk&lt;ElementType, ddc::DiscreteDomain&lt;DDims...&gt;, Allocator&gt; &amp;) [with ElementType=double, DDims=&lt;Dim1, Dim2,...&gt;, Allocator=ddc::KokkosAllocator&lt;double, Kokkos::CudaSpace&gt;]&quot;</div>
<div class="line">${GYSELALIBXX_HOME}/vendor/ddc/include/ddc/chunk.hpp(109): here cannot be referenced -- it is a deleted function</div>
</div><!-- fragment --><p>Similarly the following error then says that the lambda function itself cannot be created because the function will not work without first capturing the chunk. </p><div class="fragment"><div class="line">${GYSELALIBXX_HOME}/vendor/ddc/include/ddc/parallel_for_each.hpp(34): error: function &quot;lambda [](ArgType)-&gt;void::&lt;unnamed&gt;(const lambda [](ArgType)-&gt;void &amp;)&quot; (declared implicitly) cannot be referenced -- it is a deleted function</div>
</div><!-- fragment --><h1><a class="anchor" id="docs_Common_compilation_problems__The_enclosing_parent_function_for_an_extended____host_______device____lambda_cannot_have_private_or_protected_access_within_its_class"></a>
The enclosing parent function for an extended '__host__' '__device__' lambda cannot have private or protected access within its class</h1>
<p>Kokkos is bound by restrictions coming from various different low level languages. One of the most surprising of these is the fact that lambdas cannot be found in a private or protected context. In other words we cannot use <code>ddc::parallel_for_each</code> or <code>ddc::parallel_transform_reduce</code> in a private or protected class method.</p>
<p>In particular a google <code>TEST</code> block (as used in all the unit tests) is considered to be a private context. If you wish to put parallel loops in these tests you will need to create a function for your test and call that function from the <code>TEST</code> block.</p>
<p>This particular restriction comes from <a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#extended-lambda-restrictions">Cuda</a>:</p>
<blockquote class="doxtable">
<p>The enclosing function for the extended lambda must be named and its address can be taken. If the enclosing function is a class member, then the following conditions must be satisfied:</p>
<ul>
<li>All classes enclosing the member function must have a name.</li>
<li>The member function must not have private or protected access within its parent class.</li>
<li>All enclosing classes must not have private or protected access within their respective parent classes. </li>
</ul>
</blockquote>
<h3><a class="anchor" id="autotoc_md15"></a>
Error Message</h3>
<p>When this rule is not followed you will see the following error message: </p><div class="fragment"><div class="line">&lt;PATH_TO_FILE&gt;(&lt;LINE_NUMBER&gt;): error: The enclosing parent function (&quot;&lt;FUNCTION&gt;&quot;) for an extended __host__ __device__ lambda cannot have private or protected access within its class</div>
<div class="line">          detected during instantiation of &quot;&lt;CLASS&gt;::&lt;CLASS&gt;(Argtypes)&quot; </div>
</div><!-- fragment --><h1><a class="anchor" id="docs_Common_compilation_problems__A_nonstatic_member_reference_must_be_relative_to_a_specific_object"></a>
A nonstatic member reference must be relative to a specific object</h1>
<p>A static function in a class is a function which can be called without having an instance of a class. This can be useful to write functions which return information which is known at compile time (e.g. the degree of a spline) or to write factory functions. A factory function is a function which builds an instance of the class. This is very similar to a constructor but is a little more general. As a result it is capable of returning objects of different types (e.g. subclasses) and running extra calculations before calling the constructor.</p>
<p>For example static functions are sometimes used to initialise classes from a PDI input.</p>
<p>As the static function can be called without having an instance of a class, this error arises when you try to use the members of the class. If the function needs to use the members of the class and not simply call the constructor then the function should not be static.</p>
<h1><a class="anchor" id="docs_Common_compilation_problems__X_is_not_defined"></a>
X is not defined</h1>
<p>This usually occurs when the file containing the definition of <code>X</code> is not correctly included. Double check if the <code>#include &lt;X.hpp&gt;</code> line is in your file. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
